{{ $path := .Get "path" }}
{{ $alt := .Get "alt" | default "" }}
{{ $width := .Get "width" }}
{{ $class := .Get "class" | default "" }}
{{ $align := .Get "align" | default "" }}
{{ $pb := .Get "pb" | default "" }}

{{ $srcPath := strings.TrimPrefix "/" $path }}
{{ $src := resources.Get $srcPath }}

{{ if $src }}
  {{ $isSVG := eq $src.MediaType.SubType "svg" }}

  {{/* 1. Build CSS Styles (This works for both SVG and Raster) */}}
  {{ $finalStyle := "" }}
  {{ if eq $align "center" }}
    {{ $finalStyle = "display: block; margin-left: auto; margin-right: auto;" }}
  {{ end }}
  {{ if $width }}
    {{ $styleWidth := $width }}
    {{ if not (findRE "[a-z%]" $width) }}{{ $styleWidth = printf "%spx" $width }}{{ end }}
    {{ $finalStyle = printf "%s width: %s;" $finalStyle $styleWidth }}
  {{ end }}
  {{ if $pb }}
    {{ $finalStyle = printf "%s padding-bottom: %s;" $finalStyle $pb }}
  {{ end }}

  {{/* 2. Render Output */}}
  {{ if $isSVG }}
    {{/* SVG: No .Width call, no .Process call */}}
    <img src="{{ $src.RelPermalink }}" alt="{{ $alt }}" 
      {{ with $class }}class="{{ . }}"{{ end }}
      style="{{ $finalStyle | safeCSS }}">
  {{ else }}
    {{/* RASTER: Now it is safe to call .Width and .Process */}}
    {{ $procWidth := $src.Width }}
    {{ if $width }}
      {{ if not (in $width "%") }}
        {{ $procWidth = strings.TrimSuffix "px" $width }}
      {{ end }}
    {{ end }}

    {{- $procCommand := printf "resize %dx webp" (int $procWidth) -}}
    {{- with $src.Process $procCommand -}}
      <img src="{{ .RelPermalink }}" alt="{{ $alt }}" 
        width="{{ .Width }}" height="{{ .Height }}" 
        {{ with $class }}class="{{ . }}"{{ end }}
        style="{{ $finalStyle | safeCSS }}">
    {{- end }}
  {{ end }}

{{ else }}
  <p style="color: red; border: 1px solid red; padding: 10px;">
    <strong>Hugo Error:</strong> Image not found at <code>assets/{{ $srcPath }}</code>
  </p>
{{ end }}